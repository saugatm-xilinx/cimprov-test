ifeq (@WINDOWS@,1)
    MY_LIBS=-lcurl -lz -lpopt -lcrypto -lgdi32 \
	    -lintl -lcrypt32 -lws2_32 -lncurses @XML2_LIBS@ -llzma
    MY_CFLAGS=-DCURL_STATICLIB
    FILE_SUFFIX=.exe
else
    MY_LIBS= -Wl,-Bstatic -lpopt -lncurses -ltinfo @XML2_LIBS@ -llzma \
	     -lcurl -lssl -lcrypto -lz -lm -lrt -Wl,-Bdynamic -ldl
    MY_CFLAGS=
    FILE_SUFFIX=
endif

sfupdate_esxi$(FILE_SUFFIX): main.c fw_images.c
	@CC@ -g $^ -o $@ @MY_CPPFLAGS@ @NCURSES_CPPFLAGS@ @MY_LDFLAGS@ \
	    @XML2_CFLAGS@ $(MY_CFLAGS) $(MY_LIBS)

.PHONY : fw_images.c
fw_images.c :
	./include_fw_imgs.sh @FIRMWARE_IMG_PATHS@

clean:
	rm -rf *.o sfupdate_esxi$(FILE_SUFFIX)

distclean : clean
	rm -rf esxi_sfupdate-1.0.tar.gz Makefile config.h fw_images.c config.log config.status

.PHONY : dist
dist: esxi_sfupdate-1.0.tar.gz

esxi_sfupdate-1.0.tar.gz :
	rm -rf .esxi_sfupdate-1.0 esxi_sfupdate-1.0
	mkdir -p .esxi_sfupdate-1.0
	cp -a * .esxi_sfupdate-1.0
	mv .esxi_sfupdate-1.0 esxi_sfupdate-1.0
	tar czf $@  esxi_sfupdate-1.0